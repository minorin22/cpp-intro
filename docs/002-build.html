<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C++の実行 | 江添亮のC++入門</title>
    <meta name="description" content="">
    <link rel="icon" href="64.png">
		<script>
			MathJax = {
				chtml: {
					matchFontHeight: false
				},
				tex: {
					inlineMath: [['$', '$']]
				}
			};
		</script>
		<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
		</script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="152.png">
  <meta name="msapplication-TileImage" content="/144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="assets/css/0.styles.17f32d1e.css" as="style"><link rel="preload" href="assets/js/app.8620998f.js" as="script"><link rel="preload" href="assets/js/2.7009e9ba.js" as="script"><link rel="preload" href="assets/js/7.401cafeb.js" as="script"><link rel="prefetch" href="assets/js/10.0bc4fb9f.js"><link rel="prefetch" href="assets/js/11.c5d46ffe.js"><link rel="prefetch" href="assets/js/12.cec763ba.js"><link rel="prefetch" href="assets/js/13.85764695.js"><link rel="prefetch" href="assets/js/14.56c0c5a1.js"><link rel="prefetch" href="assets/js/15.ba58285d.js"><link rel="prefetch" href="assets/js/16.663fe3ce.js"><link rel="prefetch" href="assets/js/17.b9e53cc4.js"><link rel="prefetch" href="assets/js/18.468131c1.js"><link rel="prefetch" href="assets/js/19.966431ea.js"><link rel="prefetch" href="assets/js/20.39088cad.js"><link rel="prefetch" href="assets/js/21.f1d2fbe4.js"><link rel="prefetch" href="assets/js/22.53af9436.js"><link rel="prefetch" href="assets/js/23.45c08f75.js"><link rel="prefetch" href="assets/js/24.fec53f63.js"><link rel="prefetch" href="assets/js/25.1c55ab94.js"><link rel="prefetch" href="assets/js/26.97221aa1.js"><link rel="prefetch" href="assets/js/27.ad617385.js"><link rel="prefetch" href="assets/js/28.1d1956f2.js"><link rel="prefetch" href="assets/js/29.bb17ac3f.js"><link rel="prefetch" href="assets/js/3.a3b2b660.js"><link rel="prefetch" href="assets/js/30.3861fe0d.js"><link rel="prefetch" href="assets/js/31.93e5e7a5.js"><link rel="prefetch" href="assets/js/32.7f1f5a03.js"><link rel="prefetch" href="assets/js/33.ba1ef509.js"><link rel="prefetch" href="assets/js/34.63b70d43.js"><link rel="prefetch" href="assets/js/35.2cf21250.js"><link rel="prefetch" href="assets/js/36.93604af5.js"><link rel="prefetch" href="assets/js/37.132be8e6.js"><link rel="prefetch" href="assets/js/38.32a3f051.js"><link rel="prefetch" href="assets/js/39.bab7cf23.js"><link rel="prefetch" href="assets/js/4.3ff2fe10.js"><link rel="prefetch" href="assets/js/40.2cd9628c.js"><link rel="prefetch" href="assets/js/41.24bfe547.js"><link rel="prefetch" href="assets/js/42.39ebe085.js"><link rel="prefetch" href="assets/js/43.4ff95f43.js"><link rel="prefetch" href="assets/js/44.f1a016d7.js"><link rel="prefetch" href="assets/js/45.590d3d64.js"><link rel="prefetch" href="assets/js/46.46b99b9b.js"><link rel="prefetch" href="assets/js/47.483b5213.js"><link rel="prefetch" href="assets/js/48.65facf6a.js"><link rel="prefetch" href="assets/js/49.2bda166c.js"><link rel="prefetch" href="assets/js/5.7f8f4812.js"><link rel="prefetch" href="assets/js/50.858dc861.js"><link rel="prefetch" href="assets/js/51.a40bec0a.js"><link rel="prefetch" href="assets/js/52.f5dc4f7e.js"><link rel="prefetch" href="assets/js/53.4cfac598.js"><link rel="prefetch" href="assets/js/54.9b6224cf.js"><link rel="prefetch" href="assets/js/55.4fb7a3ba.js"><link rel="prefetch" href="assets/js/56.8a7823a6.js"><link rel="prefetch" href="assets/js/6.af1283dd.js"><link rel="prefetch" href="assets/js/8.44430c93.js"><link rel="prefetch" href="assets/js/9.39e986e2.js">
    <link rel="stylesheet" href="assets/css/0.styles.17f32d1e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="index.html" class="home-link router-link-active"><!----> <span class="site-name">江添亮のC++入門</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="000-preface.html" class="sidebar-link">序</a></li><li><a href="001-intro.html" class="sidebar-link">C++の概要</a></li><li><a href="002-build.html" class="active sidebar-link">C++の実行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="002-build.html#c-の実行の仕組み" class="sidebar-link">C++の実行の仕組み</a></li><li class="sidebar-sub-header"><a href="002-build.html#簡単な1つのソースファイルからなるプログラムの実行" class="sidebar-link">簡単な1つのソースファイルからなるプログラムの実行</a></li><li class="sidebar-sub-header"><a href="002-build.html#gcc-c-コンパイラー" class="sidebar-link">GCC: C++コンパイラー</a></li><li class="sidebar-sub-header"><a href="002-build.html#make-ビルドシステム" class="sidebar-link">Make: ビルドシステム</a></li><li class="sidebar-sub-header"><a href="002-build.html#入門用の環境構築" class="sidebar-link">入門用の環境構築</a></li></ul></li><li><a href="003-guide-to-c++.html" class="sidebar-link">C++ヒッチハイクガイド</a></li><li><a href="004-debug-compile-error.html" class="sidebar-link">デバッグ：コンパイルエラーメッセージの読み方</a></li><li><a href="005-the-restaurant-at-the-end-of-the-branch.html" class="sidebar-link">条件分岐の果てのレストラン</a></li><li><a href="006-debug-compile-warning.html" class="sidebar-link">デバッグ: コンパイル警告メッセージ</a></li><li><a href="007-standard-input.html" class="sidebar-link">最近体重が気になるあなたのための標準入力</a></li><li><a href="008-loop.html" class="sidebar-link">ループ</a></li><li><a href="009-vector.html" class="sidebar-link">メモリーを無限に確保する</a></li><li><a href="010-debug-printf.html" class="sidebar-link">デバッグ：printfデバッグ</a></li><li><a href="011-integer.html" class="sidebar-link">整数</a></li><li><a href="012-floating-point.html" class="sidebar-link">浮動小数点数</a></li><li><a href="013-names.html" class="sidebar-link">名前</a></li><li><a href="014-iterator.html" class="sidebar-link">イテレーターの基礎</a></li><li><a href="015-reference.html" class="sidebar-link">lvalueリファレンスとconst</a></li><li><a href="016-algorithm.html" class="sidebar-link">アルゴリズム</a></li><li><a href="017-lambda.html" class="sidebar-link">ラムダ式</a></li><li><a href="018-class.html" class="sidebar-link">クラスの基本</a></li><li><a href="019-operator-overloading.html" class="sidebar-link">より自然に振る舞うクラス</a></li><li><a href="020-array.html" class="sidebar-link">std::array</a></li><li><a href="021-three-virtues-of-a-programmer.html" class="sidebar-link">プログラマーの三大美徳</a></li><li><a href="022-implement-array.html" class="sidebar-link">配列</a></li><li><a href="023-template.html" class="sidebar-link">テンプレート</a></li><li><a href="024-more-array.html" class="sidebar-link">arrayをさらに実装</a></li><li><a href="025-array-iterator.html" class="sidebar-link">arrayのイテレーター</a></li><li><a href="026-exception.html" class="sidebar-link">傲慢なエラー処理: 例外</a></li><li><a href="027-pointer.html" class="sidebar-link">ポインター</a></li><li><a href="028-pointer-semantics.html" class="sidebar-link">意味上のポインター</a></li><li><a href="029-pointer-syntax.html" class="sidebar-link">文法上のポインター</a></li><li><a href="030-pointer-details.html" class="sidebar-link">ポインターの内部実装</a></li><li><a href="031-iterator-operations.html" class="sidebar-link">イテレーター詳細</a></li><li><a href="032-memory-allocation.html" class="sidebar-link">動的メモリー確保</a></li><li><a href="033-vector-implementation.html" class="sidebar-link">vectorの実装 : 基礎</a></li><li><a href="034-vector-memory-allocation.html" class="sidebar-link">vectorの実装 : メモリー確保</a></li><li><a href="035-copy.html" class="sidebar-link">コピー</a></li><li><a href="036-move.html" class="sidebar-link">ムーブ</a></li><li><a href="037-rvalue-reference.html" class="sidebar-link">rvalueリファレンス</a></li><li><a href="038-move-semantics.html" class="sidebar-link">ムーブの実装</a></li><li><a href="039-disable-copy.html" class="sidebar-link">コピーの禁止</a></li><li><a href="040-smart-pointer.html" class="sidebar-link">スマートポインター</a></li><li><a href="041-move-support.html" class="sidebar-link">自作の数値クラスで演算をムーブに対応する方法</a></li><li><a href="042-string-intro.html" class="sidebar-link">文字列</a></li><li><a href="043-random.html" class="sidebar-link">乱数</a></li><li><a href="044-random-part2.html" class="sidebar-link">ポアソン分布</a></li><li><a href="045-random-part3.html" class="sidebar-link">正規分布</a></li><li><a href="046-random-part4.html" class="sidebar-link">サンプリング分布(sampling distributions)</a></li><li><a href="200-cpp.html" class="sidebar-link">Cプリプロセッサー</a></li><li><a href="300-multiple-source-files.html" class="sidebar-link">分割コンパイル</a></li><li><a href="400-gdb.html" class="sidebar-link">デバッガー</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="c-の実行"><a href="002-build.html#c-の実行" class="header-anchor">#</a> C++の実行</h1> <p>プログラミング言語を学ぶには、まず書いたソースコードをプログラムとして実行できるようになることが重要だ。自分が正しく理解しているかどうかを確認するために書いたコードが期待どおりに動くことを確かめてこそ、正しい理解が確認できる。</p> <h2 id="c-の実行の仕組み"><a href="002-build.html#c-の実行の仕組み" class="header-anchor">#</a> C++の実行の仕組み</h2> <p>C++は慣習的に、ソースファイルをコンパイルしてオブジェクトファイルを生成し、オブジェクトファイルをリンクして実行可能ファイルを生成し、実行可能ファイルを直接実行することで実行する言語だ。</p> <p>ほかの言語では、ソースファイルをそのままパースし、解釈して実行するインタープリター形式の言語が多い。もっとも、いまとなってはソースファイルから中間言語に変換して、VM(Virtual Machine)と呼ばれる中間言語を解釈して実行するソフトウェア上で実行するとか、JIT(Just-In-Time)コンパイルしてネイティブコードを生成して実行するといった実装もあるため、昔のように単純にインタープリター型の言語ということはできなくなっている事情はある。ただし、最終的にJITコンパイルされてネイティブコードが実行される言語でも、コンパイルやコード生成はプログラマーが意識しない形で行われるため、プログラマーはコンパイラーを直接使う必要のない言語も多い。</p> <p>C++はプログラマーが直接コンパイラーを使い、ソースファイルをプログラムに変換する言語だ。</p> <h2 id="簡単な1つのソースファイルからなるプログラムの実行"><a href="002-build.html#簡単な1つのソースファイルからなるプログラムの実行" class="header-anchor">#</a> 簡単な1つのソースファイルからなるプログラムの実行</h2> <p>ここでは、典型的なC++のソースファイルをどのようにコンパイルし実行するか、一連の流れを学ぶ。</p> <h3 id="サンプルコード"><a href="002-build.html#サンプルコード" class="header-anchor">#</a> サンプルコード</h3> <p>以下のC++のソースファイルは標準出力に<code>hello</code>と出力するものだ。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>コードの詳細な意味はさておくとして、このサンプルコードを使ってC++の実行までの流れを見ていこう。</p> <p>まずは端末から作業用の適当な名前のディレクトリーを作る。ここでは<code>cpp</code>としておこう。ディレクトリーの作成は<code>mkdir</code>コマンドで行える。</p> <div class="language- extra-class"><pre class="language-text"><code>$ mkdir cpp
$ cd cpp
</code></pre></div><p>好きなテキストエディターを使って上のサンプルコードをテキストファイルとして記述する。ファイル名は<code>hello.cpp</code>としておこう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ vim hello.cpp
</code></pre></div><p>C++のソースファイルの名前は何でもよいが、慣習で使われている拡張子がいくつかある。本書では<code>.cpp</code>を使う。</p> <p>無事にソースファイルが作成できたかどうか確認してみよう。現在のカレントディレクトリー下のファイルの一覧を表示するには<code>ls</code>、ファイルの内容を表示するには<code>cat</code>を使う。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
hello.cpp
$ cat hello.cpp
#include &lt;iostream&gt;

int main()
{
    std::cout &lt;&lt; &quot;hello&quot; ;
}
</code></pre></div><h3 id="コンパイル"><a href="002-build.html#コンパイル" class="header-anchor">#</a> コンパイル</h3> <p>さて、ソースファイルが用意できたならば、いよいよコンパイルだ。</p> <p>C++のソースファイルから、実行可能ファイルを生成するソフトウェアをC++コンパイラーという。C++コンパイラーとしては、GCC(GNU Compiler Collection)とClang(クラン)がある。使い方はどちらもほぼ同じだ。</p> <p>GCCを使って先ほどの<code>hello.cpp</code>をコンパイルするには以下のようにする。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -o hello hello.cpp
</code></pre></div><p>GCCという名前のC++コンパイラーなのに<code>g++</code>なのは、<code>gcc</code>はC言語コンパイラーの名前としてすでに使われているからだ。この慣習はClangも引き継いでいて、ClangのC++コンパイラーは<code>clang++</code>だ。</p> <p>サンプルコードを間違いなくタイプしていれば、カレントディレクトリーに<code>hello</code>という実行可能ファイルが作成されるはずだ。確認してみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
hello hello.cpp
</code></pre></div><h3 id="実行"><a href="002-build.html#実行" class="header-anchor">#</a> 実行</h3> <p>さて、いよいよ実行だ。通常のOSではカレントディレクトリーが<code>PATH</code>に含まれていないため、実行するにはカレントディレクトリーからパスを指定する必要がある。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ./hello
hello
</code></pre></div><p>上出来だ。初めてのC++プログラムが実行できた。さっそくC++を学んでいきたいところだが、その前にC++プログラミングに必要なツールの使い方を学ぶ必要がある。</p> <h2 id="gcc-c-コンパイラー"><a href="002-build.html#gcc-c-コンパイラー" class="header-anchor">#</a> GCC: C++コンパイラー</h2> <p>GCCはC++のソースファイルからプログラムを生成するC++コンパイラーだ。</p> <p>GCCの基本的な使い方は以下のとおり。</p> <div class="language- extra-class"><pre class="language-text"><code>g++ その他のオプション -o 出力するファイル名 ソースファイル名
</code></pre></div><p>ソースファイル名は複数指定することができる。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -o abc a.cpp b.cpp c.cpp
</code></pre></div><p>これについては分割コンパイルの章で詳しく解説する。</p> <p>コンパイラーはメッセージを出力することがある。コンパイルメッセージには、エラーメッセージと警告メッセージとがある。</p> <p>エラーメッセージというのは、ソースコードに文法上、意味上の誤りがあるため、コンパイルできない場合に生成される。エラーメッセージはエラーの箇所も教えてくれる。ただし、文法エラーは往々にして適切な誤りの箇所を指摘できないこともある。これは、C++の文法としては正しくないテキストファイルから、妥当なC++であればどういう間違いなのかを推測する必要があるためだ。</p> <p>警告メッセージというのは、ソースコードにコンパイルを妨げる文法上、意味上の誤りは存在しないが、誤りの可能性が疑われる場合に出力される。</p> <h3 id="コンパイラーオプション"><a href="002-build.html#コンパイラーオプション" class="header-anchor">#</a> コンパイラーオプション</h3> <p>GCCのコンパイラーオプションをいくつか学んでいこう。</p> <p><code>-std=</code>はC++の規格を選択するオプションだ。C++17に準拠したいのであれば<code>-std=c++17</code>を指定する。読者が本書を読むころには、C++20や、あるいはもっと未来の規格が発行されているかもしれない。常に最新のC++規格を選択するオプションを指定するべきだ。</p> <p><code>-Wall</code>はコンパイラーの便利な警告メッセージのほとんどすべてを有効にするオプションだ。コンパイラーによる警告メッセージはプログラムの不具合を未然に発見できるので、このオプションは指定すべきだ。</p> <p><code>--pedantic-errors</code>はC++の規格を厳格に守るオプションだ。規格に違反しているコードがコンパイルエラー扱いになる。</p> <p>これをまとめると、GCCは以下のように使う。</p> <div class="language- extra-class"><pre class="language-text"><code>g++ -std=c++17 -Wall --pedantic-errors -o 出力ファイル名 入力ファイル名
</code></pre></div><p>ところで、GCCのオプションはとても多い。すべてを知りたい読者は、以下のようにしてGCCのマニュアルを読むとよい。</p> <div class="language- extra-class"><pre class="language-text"><code>$ man gcc
</code></pre></div><p>手元にマニュアルがない場合、GCCのWebサイトにあるオンラインマニュアルも閲覧できる。</p> <ul><li><a href="https://gcc.gnu.org/" target="_blank" rel="noopener noreferrer">https://gcc.gnu.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://gcc.gnu.org/onlinedocs/" target="_blank" rel="noopener noreferrer">https://gcc.gnu.org/onlinedocs/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="ヘッダーファイルの省略"><a href="002-build.html#ヘッダーファイルの省略" class="header-anchor">#</a> ヘッダーファイルの省略</h3> <p>先ほどのソースコードをもう一度見てみよう。冒頭に以下のような行がある。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
</code></pre></div><p>これは<code>#includeディレクティブ</code>(#include directive)といい、プリプロセッサー(preprocessor)の一部だ。プリプロセッサーについて詳しくは煩雑になるので巻末資料を参照してもらうとして、このコードは<code>iostream</code>ライブラリを使うために必要で、その意味としてはヘッダーファイル<code>iostream</code>の取り込みだ。</p> <p>C++の標準ライブラリを使うには、ライブラリごとに対応した<code>#includeディレクティブ</code>を書かなければならない。それはあまりにも煩雑なので、本書では標準ライブラリのヘッダーファイルをすべて<code>#include</code>した<code>ヘッダーファイル</code>(header file)を作成し、それを<code>#include</code>することで、<code>#include</code>を書かなくて済むようにする。</p> <p>そのためにはまず標準ライブラリのヘッダーファイルのほとんどすべてを<code>#include</code>したヘッダーファイル、<code>all.h</code>を作成する。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstddef&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;limits&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;climits&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cfloat&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdint&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;new&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;typeinfo&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;initializer_list&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdalign&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdexcept&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cassert&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cerrno&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;system_error&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> __has_include(&lt;string_view&gt;)</span>
<span class="token macro property">#   <span class="token directive keyword">include</span> <span class="token string">&lt;string_view&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;array&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;deque&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;forward_list&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;set&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unordered_set&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stack&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iterator&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cfenv&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;random&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;numeric&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iosfwd&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ios&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;streambuf&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;istream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> __has_include(&lt;filesystem&gt;)</span>
<span class="token macro property">#   <span class="token directive keyword">include</span> <span class="token string">&lt;filesystem&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cinttypes&gt;</span></span>


<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;regex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;shared_mutex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;future&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token operator">::</span>literals <span class="token punctuation">;</span>
</code></pre></div><p>このようなヘッダーファイル<code>all.h</code>を作成したあとに、ソースファイルで以下のように書けば、ほかのヘッダーファイルを<code>#include</code>する必要がなくなる。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;all.h&quot;</span></span>

<span class="token comment">// その他のコード</span>
</code></pre></div><p><code>//</code>から行末まではコメントで、好きなテキストを書くことができる。</p> <p>しかし、この最初の1行の<code>#include</code>も面倒だ。そこでGCCのオプション<code>-include</code>を使い、<code>all.h</code>を常に<code>#include</code>した扱いにする。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -include all.h -o program main.cpp
</code></pre></div><p>このようにすると、<code>main.cpp</code>が以下のコードでもコンパイルできるようになる。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// main.cpp</span>
<span class="token comment">// 面倒な#includeなどなし</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>これでヘッダーファイルが省略できるようになった。</p> <h3 id="コンパイル済みヘッダー-precompiled-header"><a href="002-build.html#コンパイル済みヘッダー-precompiled-header" class="header-anchor">#</a> コンパイル済みヘッダー(precompiled header)</h3> <p>C++はソースファイルをコンパイルする必要がある言語だ。コンパイルには時間がかかる。コンパイルにどれだけ時間がかかっているかを計測するには、以下のようにするとよい。</p> <div class="language- extra-class"><pre class="language-text"><code>$ time g++ -std=c++17 -Wall --pedantic-errors -include all.h -o program main.cpp
</code></pre></div><p>どうだろうか。読者の環境にもよるが、知覚できるぐらいの時間がかかっているのではないだろうか。プログラミングの習得にはコードを書いてから実行までの時間が短い方がよい。そこで本格的にC++を学ぶ前に、コンパイル時間を短縮する方法を学ぶ。</p> <p>プログラムで変更しないファイルを事前にコンパイルしておくと、変更した部分だけコンパイルすればよいので、コンパイル時間の短縮になる。GCCでは、ヘッダーファイルを事前にコンパイルする特別な機能がある。標準ライブラリのヘッダーファイルは変更しないので、事前にコンパイルしておけばコンパイル時間の短縮になる。</p> <p>事前にコンパイルしたヘッダーファイルのことをコンパイル済みヘッダー(precompiled header)という。</p> <p>すでに作成した<code>all.h</code>はコンパイル済みヘッダーとするのに適切なヘッダーファイルだ。</p> <p>コンパイル済みヘッダーファイルを作成するには、ヘッダーファイル単体をGCCに与え、出力するファイルを<code>ヘッダーファイル名.gch</code>とする。ヘッダーファイル名が<code>all.h</code>の場合、<code>all.h.gch</code>となる。</p> <p>GCCのオプションにはほかのソースファイルをコンパイルするときと同じオプションを与えるほか、ヘッダーファイルがC++で書かれていることを示すオプション<code>-x c++-header</code>を与える。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -std=c++17 -Wall --pedantic-errors -x c++-header -o all.h.gch all.h
</code></pre></div><p>こうすると、コンパイル済みヘッダーファイル<code>all.h.gch</code>が生成できる。</p> <p>GCCはヘッダーファイルを使うときに、同名の<code>.gch</code>ファイルが存在する場合は、そちらをコンパイル済みヘッダーファイルとして使うことで、ヘッダーファイルの処理を省略する。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -std=c++17 -Wall --pedantic-errors -include all.h -o program main.cpp
</code></pre></div><p>コンパイル済みヘッダーは1回のコンパイルにつき1つしか使うことができない。そのため、コンパイル済みヘッダーとするヘッダーファイルを定め、そのヘッダーファイル内にほかのヘッダーをすべて記述する。本書ではコンパイル済みヘッダーファイルとする元のヘッダーファイルの名前を<code>all.h</code>とする。</p> <p>さっそくコンパイル時間の短縮効果を確かめてみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
all.h main.cpp
$ g++ -std=c++17 -Wall --pedantic-errors -x c++-header -o all.h.gch all.h
$ ls
all.h all.h.gch main.cpp
$ time g++ -std=c++17 -Wall --pedantic-errors -include all.h -o program main.cpp
</code></pre></div><h2 id="make-ビルドシステム"><a href="002-build.html#make-ビルドシステム" class="header-anchor">#</a> Make: ビルドシステム</h2> <h3 id="コンパイルと実行のまとめ"><a href="002-build.html#コンパイルと実行のまとめ" class="header-anchor">#</a> コンパイルと実行のまとめ</h3> <p>ここまで、我々はソースファイルをコンパイルして実行可能ファイルを生成し、プログラムを実行する方法について学んできた。これまでに学んできたことを一連のコマンドで振り返ってみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
all.h main.cpp
$ cat all.h
#include &lt;iostream&gt;
$ cat main.cpp
int main() { std::cout &lt;&lt; &quot;hello&quot;s ; }
</code></pre></div><p>まず、カレントディレクトリーには<code>all.h</code>と<code>main.cpp</code>がある。この2つのファイルは実行可能ファイルを生成するために必要なファイルだ。今回、その中身は最小限にしてある。本当の<code>all.h</code>は、実際には前回書いたように長い内容になる。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -std=c++17 -Wall --pedantic-errors -x c++-header -o all.h.gch all.h
$ ls
all.h all.h.gch main.cpp
</code></pre></div><p>次に、ソースファイルのコンパイルを高速化するために、ヘッダーファイル<code>all.h</code>から、コンパイル済みヘッダーファイル<code>all.h.gch</code>を生成する。</p> <div class="language- extra-class"><pre class="language-text"><code>$ g++ -std=c++17 -Wall --pedantic-errors -include all.h -o program main.cpp
$ ls
all.h all.h.gch main.cpp program
</code></pre></div><p>プリコンパイル済みヘッダーファイル<code>all.h.gch</code>とC++ソースファイル<code>main.cpp</code>から、実行可能ファイル<code>program</code>を生成する。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ./program
hello
</code></pre></div><p>実行可能ファイル<code>program</code>を実行する。</p> <p>これで読者はC++のプログラミングを学び始めるにあたって必要なことはすべて学んだ。さっそくC++を学んでいきたいところだが、その前にもう1つ、ビルドシステムを学ぶ必要がある。</p> <h3 id="依存関係を解決するビルドシステム"><a href="002-build.html#依存関係を解決するビルドシステム" class="header-anchor">#</a> 依存関係を解決するビルドシステム</h3> <p>以上のC++のソースファイルからプログラムを実行するまでの流れは、C++のプログラムとしてはとても単純なものだが、それでも依存関係が複雑だ。</p> <p>プログラムの実行にあたって最終的に必要なのはファイル<code>program</code>だが、このファイルはGCCで生成しなければならない。ところでGCCでファイル<code>program</code>を生成するには、事前に<code>all.h</code>, <code>all.h.gch</code>, <code>main.cpp</code>が必要だ。<code>all.h.gch</code>は<code>all.h</code>からGCCで生成しなければならない。</p> <p>一度コンパイルしたプログラムのソースファイルを書き換えて再びコンパイルする場合はどうすればいいだろう。<code>main.cpp</code>だけを書き換えた場合、<code>all.h</code>は何も変更されていないので、コンパイル済みヘッダーファイル<code>all.h.gch</code>の再生成は必要ない。<code>all.h</code>だけを書き換えた場合は、<code>all.h.gch</code>を生成するだけでなく、<code>program</code>も再生成しなければならない。</p> <p>プログラムのコンパイルには、このような複雑な依存関係の解決が必要になる。依存関係の解決を人間の手で行うのはたいへんだ。例えば読者が他人によって書かれた何千ものソースファイルと、プログラムをコンパイルする手順書だけを渡されたとしよう。手順書に従ってコンパイルをしたとして、ソースファイルの一部だけを変更した場合、いったいどの手順は省略できるのか、手順書から導き出すのは難しい。するとコンパイルを最初からやり直すべきだろうか。しかし、1つのソースファイルのコンパイルに1秒かかるとして、何千ものソースファイルがある場合、何千秒もかかってしまう。たった1つのソースファイルを変更しただけですべてをコンパイルし直すのは時間と計算資源の無駄だ。</p> <p>この依存関係の問題は、ビルドシステムによって解決できる。本書ではGNU Makeというビルドシステムを学ぶ。読者がこれから学ぶビルドシステムによって、以下のような簡単なコマンドだけで、他人の書いた何千ものソースファイルからなるプログラムがコンパイル可能になる。</p> <p>何千ものソースファイルから実行可能ファイルを生成したい。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
</code></pre></div><p>これだけだ。<code>make</code>というコマンド1つでプログラムのコンパイルは自動的に行われる。</p> <p>何千ものソースファイルのうち、1つのソースファイルだけを変更し、必要な部分だけを効率よく再コンパイルしたい。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
</code></pre></div><p>これだけだ。<code>make</code>というコマンド1つでプログラムの再コンパイルは自動的に行われる。</p> <p>ところで、生成される実行可能ファイルの名前はプログラムごとにさまざまだ。プログラムの開発中は、共通の方法でプログラムを実行したい。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make run
</code></pre></div><p>これでどんなプログラム名でも共通の方法で実行できる。</p> <p>ソースファイルから生成されたプログラムなどのファイルをすべて削除したい。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make clean
</code></pre></div><p>これで生成されたファイルをすべて削除できる。</p> <p>テキストエディターにはVimを使っているがわざわざVimからターミナルに戻るのが面倒だ。</p> <div class="language- extra-class"><pre class="language-text"><code>:make
</code></pre></div><p>VimはノーマルモードからMakeを呼び出すことができる。もちろん、<code>:make run</code>や<code>:make clean</code>もできる。</p> <h3 id="依存関係を記述するルール"><a href="002-build.html#依存関係を記述するルール" class="header-anchor">#</a> 依存関係を記述するルール</h3> <p>依存関係はどのように表現したらいいのだろうか。GNU Makeでは<code>Makefile</code>という名前のファイルの中に、<code>ターゲット</code>(targets)、<code>事前要件</code>(prerequisites)、<code>レシピ</code>(recipes)という3つの概念で依存関係を<code>ルール</code>(rules)として記述する。<code>ルール</code>は以下の文法だ。</p> <div class="language- extra-class"><pre class="language-text"><code>ターゲット : 事前要件
[TAB文字]レシピ
</code></pre></div><p>レシピは必ず<code>TAB文字</code>を直前に書かなければならない。スペース文字ではだめだ。これは<code>make</code>の初心者を混乱させる落とし穴の1つとなっている。忘れずに<code>TAB文字</code>を打とう。</p> <p>問題を簡単に理解するために、以下のような状況を考えよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
source
$ cat source &gt; program
</code></pre></div><p>この例では、ファイル<code>program</code>を生成するためにはファイル<code>source</code>が必要だ。ファイル<code>source</code>はすでに存在している。</p> <p><code>ターゲット</code>は生成されるファイル名だ。この場合<code>program</code>となる。</p> <div class="language- extra-class"><pre class="language-text"><code>program : 事前要件
	レシピ
</code></pre></div><p><code>事前要件</code>は<code>ターゲット</code>を生成するために必要なファイル名だ。この場合<code>source</code>となる。</p> <div class="language- extra-class"><pre class="language-text"><code>program : source
	レシピ
</code></pre></div><p><code>レシピ</code>は<code>ターゲット</code>を生成するために必要な動作だ。この場合、<code>cat source &gt; program</code>となる</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">program </span><span class="token punctuation">:</span> source
	cat source &gt; program
</code></pre></div><p>さっそくこのルールを、ファイル<code>Makefile</code>に書き込み、<code>make</code>を呼び出してみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
Makefile source 
$ cat Makefile
program : source
	cat source &gt; program
$ make
cat source &gt; program
$ ls
Makefile program source
</code></pre></div><p>これがMakeの仕組みだ。<code>ターゲット</code>の生成に必要な<code>事前要件</code>と、<code>ターゲット</code>を生成する<code>レシピ</code>を組み合わせた<code>ルール</code>で依存関係を記述する。<code>make</code>を実行すると、実行した<code>レシピ</code>が表示される。</p> <p>もう少しMakeの<code>ルール</code>を追加してみよう。例えばファイル<code>source</code>はあらかじめ存在するのではなく、ファイル<code>source01</code>, <code>source02</code>, <code>source03</code>の中身をこの順番で連結して生成するとしよう。以下のように書ける。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">program </span><span class="token punctuation">:</span> source
	cat source &gt; program

<span class="token symbol">source </span><span class="token punctuation">:</span> source01 source02 source03
	cat source01 source02 source03 &gt; source
</code></pre></div><p>GNU Makeはカレントディレクトリーにあるファイル<code>Makefile</code>の一番上に書かれたルールを実行しようとする。<code>program</code>を生成するには<code>source</code>が必要だが、<code>source</code>の生成には別のルールの実行が必要だ。<code>Makefile</code>はこの依存関係を自動で解決してくれる。</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch source01 source02 source03
$ ls
Makefile source01 source02 source03
$ make
cat source01 source02 source03 &gt; source
cat source &gt; program
$ ls
Makefile program source source01 source02 source03
</code></pre></div><p>すでに<code>make</code>を実行したあとで、もう一度<code>make</code>を実行するとどうなるだろうか。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
make: 'program' is up to date.
</code></pre></div><p>このメッセージの意味は「<code>program</code>は最新だ」という意味だ。<code>make</code>はファイルのタイムスタンプを調べ、もしファイル<code>program</code>より<code>source</code>のタイムスタンプの方が若い場合、つまり<code>program</code>が変更されたよりもあとに<code>source</code>が変更された場合、<code>ルール</code>を実行する。</p> <p>試しにファイル<code>source02</code>のタイムスタンプを更新してみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch source02
$ make
cat source01 source02 source03 &gt; source
cat source &gt; program
</code></pre></div><p>ファイル<code>source</code>は<code>事前要件</code>に<code>source02</code>を含む。<code>source02</code>のタイムスタンプが<code>source</code>より若いので、<code>source</code>が再び生成される。すると、<code>source</code>のタイムスタンプが<code>program</code>のタイムスタンプよりも若くなったので、<code>program</code>も生成される。</p> <p>もう1つ例を見てみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch a b c
$ ls
a b c Makefile
</code></pre></div><p>あるディレクトリーにファイル<code>a</code>, <code>b</code>, <code>c</code>がある。</p> <p><code>Makefile</code>は以下の内容になっている。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">D </span><span class="token punctuation">:</span> A B C
	cat A B C &gt; D

<span class="token symbol">A </span><span class="token punctuation">:</span> a
	cat a &gt; A

<span class="token symbol">B </span><span class="token punctuation">:</span> b
	cat b &gt; B

<span class="token symbol">C </span><span class="token punctuation">:</span> c
	cat c &gt; C
</code></pre></div><p>この<code>Makefile</code>を呼び出したときに作られるのはファイル<code>D</code>だ。ファイル<code>D</code>を作るにはファイル<code>A</code>, <code>B</code>, <code>C</code>が必要だ。このファイルはそれぞれファイル<code>a</code>, <code>b</code>, <code>c</code>から生成されるルールが記述してある。</p> <p>これを<code>make</code>すると以下のようにファイル<code>A</code>, <code>B</code>, <code>C</code>, <code>D</code>が作られる。</p> <div class="language- extra-class"><pre class="language-text"><code>$ ls
a b c Makefile
$ make
cat a &gt; A
cat b &gt; B
cat c &gt; C
cat A B C &gt; D
</code></pre></div><p>ここで、ファイル<code>b</code>のタイムスタンプだけを更新して<code>make</code>してみよう。</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch b
$ make
cat b &gt; B
cat A B C &gt; D
</code></pre></div><p>ファイル<code>b</code>のタイムスタンプがファイル<code>B</code>より若くなったので、ファイル<code>B</code>がターゲットとなったルールが再び実行される。ファイル<code>A</code>, <code>C</code>のルールは実行されない。そしてファイル<code>B</code>のタイムスタンプがファイル<code>D</code>より若くなったので、ファイル<code>D</code>がターゲットとなったルールが再び実行される。</p> <p><code>make</code>により、処理する必要のあるルールだけが部分的に処理されていることがわかる。</p> <p><code>make</code>は適切な<code>ルール</code>さえ書けば、依存関係の解決を自動的に行ってくれる。</p> <h3 id="コメント"><a href="002-build.html#コメント" class="header-anchor">#</a> コメント</h3> <p><code>Makefile</code>にはコメントを書くことができる。<code>#</code>で始まる行はコメント扱いされる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token comment"># programを生成するルール</span>
<span class="token symbol">program </span><span class="token punctuation">:</span> source
	cat source &gt; program

<span class="token comment"># sourceを生成するルール</span>
<span class="token symbol">source </span><span class="token punctuation">:</span> source01 source02 source03
	cat source01 source02 source03 &gt; source
</code></pre></div><h3 id="変数"><a href="002-build.html#変数" class="header-anchor">#</a> 変数</h3> <p><code>Makefile</code>には<code>変数</code>を書くことができる。</p> <p>変数の文法は以下のとおり。</p> <div class="language- extra-class"><pre class="language-text"><code>variable = foobar

target : $(variable)
</code></pre></div><p>これは、</p> <div class="language- extra-class"><pre class="language-text"><code>target : foobar
</code></pre></div><p>と書いたものと同じように扱われる。</p> <p>変数は<code>=</code>の左側に変数名、右側に変数の内容を書く。</p> <p>変数を使うときは、<code>$(変数名)</code>のように、<code>$()</code>で変数名を包む。</p> <h3 id="自動変数"><a href="002-build.html#自動変数" class="header-anchor">#</a> 自動変数</h3> <p>GNU Makeは便利なことに、いくつかの変数を自動で作ってくれる。</p> <h4 id="ターゲット"><a href="002-build.html#ターゲット" class="header-anchor">#</a> <code><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7a5e3a">[email&#160;protected]</a></code> ターゲット</h4> <p><code><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="674327">[email&#160;protected]</a></code>はルールのターゲットのファイル名になる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">target </span><span class="token punctuation">:</span>
	echo <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="163256">[email&#160;protected]</a></span>
</code></pre></div><p>この<code>Makefile</code>を実行すると以下のように出力される。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
echo target
</code></pre></div><h4 id="最初の事前要件"><a href="002-build.html#最初の事前要件" class="header-anchor">#</a> <code>$&lt;</code> 最初の事前要件</h4> <p><code>$&lt;</code>はルールの最初の事前要件のファイル名になる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">target </span><span class="token punctuation">:</span> A B C
	echo <span class="token variable">$&lt;</span>
</code></pre></div><p>この<code>Makefile</code>を実行すると以下のように出力される。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
echo A
</code></pre></div><h4 id="すべての事前要件"><a href="002-build.html#すべての事前要件" class="header-anchor">#</a> <code>$^</code> すべての事前要件</h4> <p><code>$^</code>はすべての事前要件のファイル名が空白区切りされたものになる</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">target </span><span class="token punctuation">:</span> A B C
	echo <span class="token variable">$^</span>
</code></pre></div><p>この<code>Makefile</code>を実行すると以下のように出力される。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
echo A B C
</code></pre></div><h4 id="自動変数の組み合わせ"><a href="002-build.html#自動変数の組み合わせ" class="header-anchor">#</a> 自動変数の組み合わせ</h4> <p>例えば<code>ターゲット</code>を生成するために<code>事前要件</code>と<code>ターゲット</code>のファイル名をレシピに書く場合、</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">target </span><span class="token punctuation">:</span> prerequisite
	cat prerequisite &gt; target
</code></pre></div><p>と書く代わりに、</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">target </span><span class="token punctuation">:</span> prerequisite
    cat <span class="token variable">$&lt;</span> &gt; <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="82a6c2">[email&#160;protected]</a></span>
</code></pre></div><p>と書ける。</p> <h3 id="phonyターゲット"><a href="002-build.html#phonyターゲット" class="header-anchor">#</a> PHONYターゲット</h3> <p>PHONYターゲットとは、ファイル名を意味せず、単にレシピを実行するターゲット名としてのみ機能するターゲットのことだ。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">hi </span><span class="token punctuation">:</span>
	echo hi

<span class="token symbol">hello </span><span class="token punctuation">:</span>
	echo hello
</code></pre></div><p>これを実行すると以下のようになる。</p> <div class="language- extra-class"><pre class="language-text"><code>$ make
echo hi
hi
$ make hi
echo hi
hi
$ make hello
echo hello
hello
</code></pre></div><p><code>make</code>を引数を付けずに実行すると、一番上に書かれたルールが実行される。引数としてターゲットを指定すると、そのターゲットのルールと、依存するルールが実行される。</p> <p>ただし、ターゲットと同じファイル名が存在すると、ルールは実行されない。</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch hello
$ make hello
make: 'hello' is up to date.
</code></pre></div><p>GNU Makeはこの問題に対処するため、<code>.PHONY</code>ターゲットという特殊な機能がある。これはPHONYターゲットを<code>.PHONY</code>ターゲットの事前要件とすることで、ターゲットと同じファイル名の存在の有無にかかわらずルールを実行させられる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">hello </span><span class="token punctuation">:</span>
	echo hello

<span class="token builtin">.PHONY</span><span class="token symbol"> </span><span class="token punctuation">:</span> hello
</code></pre></div><p>PHONYターゲットはコンパイルしたプログラムの実行や削除に使うことができる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">hello </span><span class="token punctuation">:</span> hello.cpp
	g++ -o <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="eecaae">[email&#160;protected]</a></span> <span class="token variable">$&lt;</span>

<span class="token symbol">run </span><span class="token punctuation">:</span> hello
	./hello

<span class="token symbol">clean </span><span class="token punctuation">:</span>
	rm -rf ./hello

<span class="token builtin">.PHONY</span><span class="token symbol"> </span><span class="token punctuation">:</span> run clean
</code></pre></div><h2 id="入門用の環境構築"><a href="002-build.html#入門用の環境構築" class="header-anchor">#</a> 入門用の環境構築</h2> <p>以上を踏まえて、C++入門用の環境構築をしてこの章のまとめとする。</p> <p>今回構築する環境のファイル名とその意味は以下のとおり。</p> <p><code>main.cpp</code>
:   C++のコードを書く
<code>all.h</code>
:   標準ライブラリのヘッダーファイルを書く
<code>all.h.gch</code>
:   コンパイル済みヘッダー
<code>program</code>
:   実行可能ファイル
<code>Makefile</code>
:   GNU Makeのルールを書く</p> <p>使い方は以下のとおり。</p> <p><code>make</code>
:   コンパイルする
<code>make run</code>
:   コンパイルして実行
<code>make clean</code>
:   コンパイル結果を削除</p> <p>GCCに与えるコンパイラーオプションを変数にまとめる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>gcc_options <span class="token operator">=</span> -std<span class="token operator">=</span>c++17 -Wall --pedantic-error
</code></pre></div><p>言語はC++17、すべての警告を有効にし、規格準拠ではないコードはエラーとする。</p> <p>プログラムをコンパイルする部分は以下のとおり。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">program </span><span class="token punctuation">:</span> main.cpp all.h all.h.gch
	g++ <span class="token variable">$</span><span class="token punctuation">(</span>gcc_options<span class="token punctuation">)</span> <span class="token keyword">-include</span> all.h <span class="token variable">$&lt;</span> -o <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2f0b6f">[email&#160;protected]</a></span>

<span class="token symbol">all.h.gch </span><span class="token punctuation">:</span> all.h
	g++ <span class="token variable">$</span><span class="token punctuation">(</span>gcc_options<span class="token punctuation">)</span> -x c++-header -o <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5e7a1e">[email&#160;protected]</a></span> <span class="token variable">$&lt;</span>
</code></pre></div><p>実行可能ファイル<code>program</code>と、コンパイル済みヘッダー<code>all.h.gch</code>をコンパイルするルールだ。</p> <p>PHONYターゲットは以下のとおり。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">run </span><span class="token punctuation">:</span> program
	./program

<span class="token symbol">clean </span><span class="token punctuation">:</span>
	rm -f ./program
	rm -f ./all.h.gch

<span class="token builtin">.PHONY</span><span class="token symbol"> </span><span class="token punctuation">:</span> run clean
</code></pre></div><p><code>make</code>でコンパイル。<code>make run</code>で実行。<code>make clean</code>でコンパイル結果の削除。</p> <p><code>Makefile</code>全体は以下のようになる。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>gcc_options <span class="token operator">=</span> -std<span class="token operator">=</span>c++17 -Wall --pedantic-errors

<span class="token symbol">program </span><span class="token punctuation">:</span> main.cpp all.h all.h.gch
	g++ <span class="token variable">$</span><span class="token punctuation">(</span>gcc_options<span class="token punctuation">)</span> <span class="token keyword">-include</span> all.h <span class="token variable">$&lt;</span> -o <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="022642">[email&#160;protected]</a></span>

<span class="token symbol">all.h.gch </span><span class="token punctuation">:</span> all.h
	g++ <span class="token variable">$</span><span class="token punctuation">(</span>gcc_options<span class="token punctuation">)</span> -x c++-header -o <span class="token variable"><a href="cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e0c4a0">[email&#160;protected]</a></span> <span class="token variable">$&lt;</span>

<span class="token symbol">run </span><span class="token punctuation">:</span> program
	./program

<span class="token symbol">clean </span><span class="token punctuation">:</span>
	rm -f ./program
	rm -f ./all.h.gch

<span class="token builtin">.PHONY</span><span class="token symbol"> </span><span class="token punctuation">:</span> run clean
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="001-intro.html" class="prev">C++の概要</a></span> <span class="next"><a href="003-guide-to-c++.html">C++ヒッチハイクガイド</a>
      →
    </span></p></div> </main></div><div class="global-ui"><SWUpdatePopup></SWUpdatePopup></div></div>
    <script data-cfasync="false" src="cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="assets/js/app.8620998f.js" defer></script><script src="assets/js/2.7009e9ba.js" defer></script><script src="assets/js/7.401cafeb.js" defer></script>
  </body>
</html>
